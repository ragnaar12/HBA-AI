<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Assistant UniSign</title>
  <style>
    /* Ton CSS inchangé */
  </style>
</head>
<body>
  <h1>Assistant UniSign</h1>

  <div id="chat-container">
    <div id="chatbox"></div>
    <div id="input-container">
      <input type="text" id="userInput" placeholder="Posez votre question..." autocomplete="off"/>
      <button id="sendButton">Envoyer</button>
    </div>
  </div>

  <script>
    const API_KEY = "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"; // NE PAS exposer en production
    const API_URL = "https://api.openai.com/v1/chat/completions";

    const chatbox = document.getElementById("chatbox");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");

    function addMessage(sender, content) {
      const div = document.createElement("div");
      div.className = sender + "-message message";
      div.innerText = content; // innerText pour meilleure compatibilité
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
      return div;
    }

    async function typeText(div, text) {
      div.innerText = "";
      for (let i = 0; i < text.length; i++) {
        div.innerText += text[i];
        await new Promise(resolve => setTimeout(resolve, 20));
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage("user", message);
      userInput.value = "";

      const typing = document.createElement("div");
      typing.className = "typing-indicator";
      typing.innerText = "Assistant rédige sa réponse...";
      chatbox.appendChild(typing);
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`,
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: message }],
            temperature: 0.7,
            max_tokens: 1000
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Erreur API OpenAI: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        chatbox.removeChild(typing);
        console.log("Réponse OpenAI:", data);

        const reply = data?.choices?.[0]?.message?.content;
        if (!reply) {
          throw new Error("Réponse vide ou invalide.");
        }

        const botDiv = addMessage("bot", ""); // div vide à remplir progressivement
        await typeText(botDiv, reply);

      } catch (err) {
        if (chatbox.contains(typing)) {
          chatbox.removeChild(typing);
        }
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerText = "Erreur : " + err.message;
        chatbox.appendChild(errorDiv);
        chatbox.scrollTop = chatbox.scrollHeight;
        console.error(err);
      }
    }

    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
